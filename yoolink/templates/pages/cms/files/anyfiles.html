{% extends 'cmsbase.html' %}
{% load static compress %}
{% block title %} {{ block.super }} | CMS | Dateien{% endblock %}

{% block content %}
<!--Edit Title Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
  <div class="bg-white py-6 px-12 rounded shadow-lg w-full max-w-md modal-container">
    <h2 class="text-lg font-bold mb-4">Titel bearbeiten</h2>
    <input type="text" id="fileTitleInput" class="w-full p-2 border rounded mb-4" />
    {% csrf_token %}
    <div class="flex justify-end gap-2">
      <button id="cancelEdit" class="bg-gray-300 px-4 py-2 rounded">Abbrechen</button>
      <button id="saveEdit" class="bg-blue-600 text-white px-4 py-2 rounded">Speichern</button>
    </div>
  </div>
</div>
<div class="container mx-auto mt-8">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
    <h1 class="text-2xl">
      <a href="{% url 'cms:cms-files' %}" class="text-blue-500">Dateien</a> - Dateiupload
      <span class="ml-2 text-sm text-gray-500">({{ total_count }} Dateien)</span>
    </h1>

    <div class="flex items-center gap-3">
      <!-- Pro-Seite Auswahl -->
      <form method="get" class="flex items-center gap-2">
        <label class="text-sm text-gray-600">Pro Seite</label>
        <select name="per_page" class="rounded-md border-gray-300 text-sm" onchange="this.form.submit()">
          <option value="12" {% if per_page == 12 %}selected{% endif %}>12</option>
          <option value="24" {% if per_page == 24 %}selected{% endif %}>24</option>
          <option value="48" {% if per_page == 48 %}selected{% endif %}>48</option>
          <option value="96" {% if per_page == 96 %}selected{% endif %}>96</option>
        </select>
        {# andere GET-Parameter erhalten #}
        {% for key, val in request.GET.items %}
          {% if key != 'per_page' and key != 'page' %}
            <input type="hidden" name="{{ key }}" value="{{ val }}">
          {% endif %}
        {% endfor %}
      </form>

      <a href="{% url 'cms:anyfile-uploader' %}"
         class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
        <i class="bi bi-file-earmark-plus"></i> Dateien hochladen
      </a>
    </div>
  </div>

  {% csrf_token %}

  {% if files %}
    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 mt-8">
      {% for file in files %}
        <div class="relative p-4 border rounded shadow flex flex-col justify-between">
          <a href="{{ file.file.url }}" target="_blank" class="text-blue-600 truncate flex items-center gap-2 mb-4">
            {% with file.file.name|lower as filename %}
              {% if ".jpg" in filename or ".jpeg" in filename or ".png" in filename or ".webp" in filename %}
                <i class="bi bi-card-image text-yellow-600 text-xl"></i>
              {% elif ".pdf" in filename %}
                <i class="bi bi-file-earmark-pdf-fill text-red-600 text-xl"></i>
              {% elif ".zip" in filename or ".rar" in filename %}
                <i class="bi bi-file-earmark-zip-fill text-gray-600 text-xl"></i>
              {% elif ".doc" in filename or ".docx" in filename %}
                <i class="bi bi-file-earmark-word-fill text-blue-700 text-xl"></i>
              {% elif ".xls" in filename or ".xlsx" in filename %}
                <i class="bi bi-file-earmark-excel-fill text-green-600 text-xl"></i>
              {% else %}
                <i class="bi bi-file-earmark-fill text-gray-500 text-xl"></i>
              {% endif %}
            {% endwith %}
            {{ file.title|default:file.file.name|truncatechars:40 }}
          </a>

          <div class="flex justify-end gap-2 mt-auto">
            <button
              class="edit-file bg-yellow-500 hover:bg-yellow-600 text-white text-sm px-3 py-1 rounded flex items-center gap-1"
              data-id="{{ file.id }}">
              <i class="bi bi-pencil"></i> Anpassen
            </button>
            <button
              class="delete-file bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1 rounded flex items-center gap-1"
              data-id="{{ file.id }}">
              <i class="bi bi-trash"></i> L√∂schen
            </button>
          </div>
        </div>
      {% endfor %}
    </div>

    {# Pagination #}
    {% if page_obj.paginator.num_pages > 1 %}
      <nav class="flex items-center justify-between mt-6" aria-label="Pagination">
        <div class="text-sm text-gray-600">
          Seite {{ page_obj.number }} von {{ page_obj.paginator.num_pages }} ‚Äì
          Eintr√§ge {{ page_obj.start_index }}‚Äì{{ page_obj.end_index }} von {{ page_obj.paginator.count }}
        </div>

        <div class="inline-flex items-center space-x-1">
          {% if page_obj.has_previous %}
            <a href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.previous_page_number }}"
               class="px-3 py-1 rounded-md border text-sm hover:bg-gray-50">‚Äπ Zur√ºck</a>
          {% else %}
            <span class="px-3 py-1 rounded-md border text-sm text-gray-400">‚Äπ Zur√ºck</span>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if num == page_obj.number %}
              <span class="px-3 py-1 rounded-md bg-blue-500 text-white text-sm">{{ num }}</span>
            {% elif num >= page_obj.number|add:-2 and num <= page_obj.number|add:2 %}
              <a href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ num }}"
                 class="px-3 py-1 rounded-md border text-sm hover:bg-gray-50">{{ num }}</a>
            {% elif num == 1 or num == page_obj.paginator.num_pages %}
              <a href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ num }}"
                 class="px-3 py-1 rounded-md border text-sm hover:bg-gray-50">{{ num }}</a>
            {% elif forloop.first or forloop.last %}
              <span class="px-2 text-gray-400">‚Ä¶</span>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <a href="?{% if querystring %}{{ querystring }}&{% endif %}page={{ page_obj.next_page_number }}"
               class="px-3 py-1 rounded-md border text-sm hover:bg-gray-50">Weiter ‚Ä∫</a>
          {% else %}
            <span class="px-3 py-1 rounded-md border text-sm text-gray-400">Weiter ‚Ä∫</span>
          {% endif %}
        </div>
      </nav>
    {% endif %}
  {% else %}
    <div class="mt-10 text-gray-500">Keine Dateien vorhanden.</div>
  {% endif %}
</div>
{% endblock %}

{% block javascriptend %}
{% compress js inline %}
<script>
  
// WARTEN bis DOM bereit ist (robust, auch bei Turbolinks/HTMX optional siehe unten)
$(function () {
  // CSRF finden (falls mehrere vorhanden, nimm das erste sichtbare; sonst erstes im DOM)
  const $csrf = $('[name=csrfmiddlewaretoken]:visible').first().length 
    ? $('[name=csrfmiddlewaretoken]:visible').first()
    : $('[name=csrfmiddlewaretoken]').first();
  const csrftoken = $csrf.val();

  // üî¥ Delete: delegiertes Event (funktioniert auch bei nachgeladenen Inhalten/Pagination)
  $(document).on('click', '.delete-file', function (e) {
    e.preventDefault();
    e.stopPropagation();

    const id = $(this).data('id');
    const $card = $(this).closest('.relative');

    if (!id) {
      console.warn('Kein data-id auf .delete-file gefunden');
      return;
    }

    // Safety: ist Swal verf√ºgbar?
    if (typeof Swal === 'undefined') {
      console.error('SweetAlert2 (Swal) nicht geladen.');
      return;
    }

    Swal.fire({
      title: 'Bist du sicher?',
      text: 'Diese Datei wird dauerhaft gel√∂scht.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Ja, l√∂schen!',
      cancelButtonText: 'Abbrechen'
    }).then((result) => {
      if (!result.isConfirmed) return;

      $.ajax({
        url: `/cms/anyfiles/delete/${id}/`,
        method: 'POST',
        data: { csrfmiddlewaretoken: csrftoken },
        success: function (response) {
          if (response && response.success) {
            $card.remove();
            Swal.fire('Gel√∂scht!', 'Die Datei wurde gel√∂scht.', 'success');
          } else {
            Swal.fire('Fehler', (response && response.error) || 'Unbekannter Fehler', 'error');
          }
        },
        error: function (xhr) {
          Swal.fire('Fehler', `HTTP ${xhr.status}: ${xhr.responseText || 'Es ist ein Fehler aufgetreten.'}`, 'error');
        }
      });
    });
  });

  // ‚úèÔ∏è Edit (delegiert lassen, analog zu oben)
  $(document).on('click', '.edit-file', function (e) {
    e.preventDefault();
    e.stopPropagation();

    const id = $(this).data('id');
    window.currentEditId = id;

    const $parent = $(this).closest('.relative');
    const $displayLink = $parent.find('a').first();
    const currentTitle = $displayLink.text().trim();

    $('#fileTitleInput').val(currentTitle);
    window.currentEditElem = $displayLink;
    $('#editModal').removeClass('hidden');
  });

  $('#cancelEdit').on('click', function () {
    $('#editModal').addClass('hidden');
    window.currentEditId = null;
    window.currentEditElem = null;
  });

  $('#saveEdit').on('click', function () {
    const newTitle = $('#fileTitleInput').val().trim();

    $.ajax({
      url: `/cms/anyfiles/update/${window.currentEditId}/`,
      method: 'POST',
      data: {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').first().val(),
        title: newTitle
      },
      success: function (response) {
        if (response && response.success) {
          Swal.fire({ title: 'Erfolgreich gespeichert!', icon: 'success', timer: 1200, showConfirmButton: false });
          const $icon = window.currentEditElem.find('i'); 
          window.currentEditElem.empty().append($icon).append(' ' + newTitle);
        } else {
          Swal.fire('Fehler', (response && response.error) || 'Unbekannter Fehler', 'error');
        }
        $('#editModal').addClass('hidden');
      },
      error: function () {
        Swal.fire('Fehler', 'Es ist ein Fehler aufgetreten.', 'error');
        $('#editModal').addClass('hidden');
      }
    });
  });
});


</script>
{% endcompress js %}
{% endblock %}
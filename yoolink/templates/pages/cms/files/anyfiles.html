{% extends 'cmsbase.html' %}
{% load static compress %}
{% block title %} {{ block.super }} | CMS | Dateien{% endblock %}

{% block content %}
<!--Edit Title Modal -->
<div id="editModal" class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50">
  <div class="bg-white py-6 px-12 rounded shadow-lg w-full max-w-md modal-container">
    <h2 class="text-lg font-bold mb-4">Titel bearbeiten</h2>
    <input type="text" id="fileTitleInput" class="w-full p-2 border rounded mb-4" />
    {% csrf_token %}
    <div class="flex justify-end gap-2">
      <button id="cancelEdit" class="bg-gray-300 px-4 py-2 rounded">Abbrechen</button>
      <button id="saveEdit" class="bg-blue-600 text-white px-4 py-2 rounded">Speichern</button>
    </div>
  </div>
</div>
<div class="container mx-auto mt-8">
  <div class="flex justify-between">
    <h1 class="text-2xl"><a href="{% url 'cms:cms-files' %}" class="text-blue-500">Dateien</a> - Dateiupload</h1>
    <a href="{% url 'cms:anyfile-uploader' %}" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">
      <i class="bi bi-file-earmark-plus"></i> Dateien hochladen
    </a>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mt-8">
    {% for file in files %}
    <div class="relative p-4 border rounded shadow flex flex-col justify-between">
      <a href="{{ file.file.url }}" target="_blank" class="text-blue-600 truncate flex items-center gap-2 mb-4">
        {% with file.file.name|lower as filename %}
        {% if ".jpg" in filename or ".jpeg" in filename or ".png" in filename or ".webp" in filename %}
        <i class="bi bi-card-image text-yellow-600 text-xl"></i>
        {% elif ".pdf" in filename %}
        <i class="bi bi-file-earmark-pdf-fill text-red-600 text-xl"></i>
        {% elif ".zip" in filename or ".rar" in filename %}
        <i class="bi bi-file-earmark-zip-fill text-gray-600 text-xl"></i>
        {% elif ".doc" in filename or ".docx" in filename %}
        <i class="bi bi-file-earmark-word-fill text-blue-700 text-xl"></i>
        {% elif ".xls" in filename or ".xlsx" in filename %}
        <i class="bi bi-file-earmark-excel-fill text-green-600 text-xl"></i>
        {% else %}
        <i class="bi bi-file-earmark-fill text-gray-500 text-xl"></i>
        {% endif %}
        {% endwith %}
        {{ file.title|default:file.file.name|truncatechars:40 }}
      </a>

      <div class="flex justify-end gap-2 mt-auto">
        <button
          class="edit-file bg-yellow-500 hover:bg-yellow-600 text-white text-sm px-3 py-1 rounded flex items-center gap-1"
          data-id="{{ file.id }}">
          <i class="bi bi-pencil"></i> Anpassen
        </button>
        <button
          class="delete-file bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-1 rounded flex items-center gap-1"
          data-id="{{ file.id }}">
          <i class="bi bi-trash"></i> L√∂schen
        </button>
      </div>
    </div>

    {% endfor %}
  </div>
  {% if files.has_other_pages %}
  <div class="flex justify-center mt-8">
    <nav class="inline-flex items-center space-x-1">
      {% if files.has_previous %}
      <a href="?page={{ files.previous_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬´</a>
      {% endif %}

      {% for num in files.paginator.page_range %}
      {% if files.number == num %}
      <span class="px-3 py-1 bg-blue-500 text-white rounded">{{ num }}</span>
      {% elif num > files.number|add:'-3' and num < files.number|add:'3' %} <a href="?page={{ num }}"
        class="px-3 py-1 bg-gray-100 rounded hover:bg-gray-200">{{ num }}</a>
        {% endif %}
        {% endfor %}

        {% if files.has_next %}
        <a href="?page={{ files.next_page_number }}" class="px-3 py-1 bg-gray-200 rounded hover:bg-gray-300">¬ª</a>
        {% endif %}
    </nav>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block javascriptend %}
{% compress js inline %}
<script>
  
// WARTEN bis DOM bereit ist (robust, auch bei Turbolinks/HTMX optional siehe unten)
$(function () {
  // CSRF finden (falls mehrere vorhanden, nimm das erste sichtbare; sonst erstes im DOM)
  const $csrf = $('[name=csrfmiddlewaretoken]:visible').first().length 
    ? $('[name=csrfmiddlewaretoken]:visible').first()
    : $('[name=csrfmiddlewaretoken]').first();
  const csrftoken = $csrf.val();

  // üî¥ Delete: delegiertes Event (funktioniert auch bei nachgeladenen Inhalten/Pagination)
  $(document).on('click', '.delete-file', function (e) {
    e.preventDefault();
    e.stopPropagation();

    const id = $(this).data('id');
    const $card = $(this).closest('.relative');

    if (!id) {
      console.warn('Kein data-id auf .delete-file gefunden');
      return;
    }

    // Safety: ist Swal verf√ºgbar?
    if (typeof Swal === 'undefined') {
      console.error('SweetAlert2 (Swal) nicht geladen.');
      return;
    }

    Swal.fire({
      title: 'Bist du sicher?',
      text: 'Diese Datei wird dauerhaft gel√∂scht.',
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#d33',
      cancelButtonColor: '#3085d6',
      confirmButtonText: 'Ja, l√∂schen!',
      cancelButtonText: 'Abbrechen'
    }).then((result) => {
      if (!result.isConfirmed) return;

      $.ajax({
        url: `/cms/anyfiles/delete/${id}/`,
        method: 'POST',
        data: { csrfmiddlewaretoken: csrftoken },
        success: function (response) {
          if (response && response.success) {
            $card.remove();
            Swal.fire('Gel√∂scht!', 'Die Datei wurde gel√∂scht.', 'success');
          } else {
            Swal.fire('Fehler', (response && response.error) || 'Unbekannter Fehler', 'error');
          }
        },
        error: function (xhr) {
          Swal.fire('Fehler', `HTTP ${xhr.status}: ${xhr.responseText || 'Es ist ein Fehler aufgetreten.'}`, 'error');
        }
      });
    });
  });

  // ‚úèÔ∏è Edit (delegiert lassen, analog zu oben)
  $(document).on('click', '.edit-file', function (e) {
    e.preventDefault();
    e.stopPropagation();

    const id = $(this).data('id');
    window.currentEditId = id;

    const $parent = $(this).closest('.relative');
    const $displayLink = $parent.find('a').first();
    const currentTitle = $displayLink.text().trim();

    $('#fileTitleInput').val(currentTitle);
    window.currentEditElem = $displayLink;
    $('#editModal').removeClass('hidden');
  });

  $('#cancelEdit').on('click', function () {
    $('#editModal').addClass('hidden');
    window.currentEditId = null;
    window.currentEditElem = null;
  });

  $('#saveEdit').on('click', function () {
    const newTitle = $('#fileTitleInput').val().trim();

    $.ajax({
      url: `/cms/anyfiles/update/${window.currentEditId}/`,
      method: 'POST',
      data: {
        csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').first().val(),
        title: newTitle
      },
      success: function (response) {
        if (response && response.success) {
          Swal.fire({ title: 'Erfolgreich gespeichert!', icon: 'success', timer: 1200, showConfirmButton: false });
          const $icon = window.currentEditElem.find('i'); 
          window.currentEditElem.empty().append($icon).append(' ' + newTitle);
        } else {
          Swal.fire('Fehler', (response && response.error) || 'Unbekannter Fehler', 'error');
        }
        $('#editModal').addClass('hidden');
      },
      error: function () {
        Swal.fire('Fehler', 'Es ist ein Fehler aufgetreten.', 'error');
        $('#editModal').addClass('hidden');
      }
    });
  });
});


</script>
{% endcompress js %}
{% endblock %}
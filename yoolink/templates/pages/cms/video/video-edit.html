{% extends 'cmsbase.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}{{ block.super }} | CMS | Video bearbeiten{% endblock %}

{% block content %}
<div class="container mx-auto mt-8 max-w-4xl">
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-2xl">
      <a href="{% url 'cms:cms-files' %}" class="text-blue-500">Dateien</a> /
      <a href="{% url 'cms:list_videos' %}" class="text-blue-500">Videos</a> /
      <span id="videoTitle">{{ video.title|default:"Video Titel" }}</span>
    </h1>
    <div>
      {% csrf_token %}
      <a class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded hover:cursor-pointer"
        id="editVideo">
        Speichern
      </a>
    </div>
  </div>

  <form id="video-edit-form" enctype="multipart/form-data" method="POST">
    {% csrf_token %}

    <!-- File Inputs -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Neues Video (optional)</label>
        <input type="file" name="file" accept="video/*" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4
             file:rounded-lg file:border-0
             file:text-sm file:font-semibold
             file:bg-blue-100 file:text-blue-700
             hover:file:bg-blue-200
             focus:outline-none focus:ring-2 focus:ring-blue-300">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Neues Thumbnail (optional)</label>
        <input type="file" name="thumbnail" accept="image/*" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4
             file:rounded-lg file:border-0
             file:text-sm file:font-semibold
             file:bg-green-100 file:text-green-700
             hover:file:bg-green-200
             focus:outline-none focus:ring-2 focus:ring-green-300">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">Neue Untertitel (.vtt, optional)</label>
        <input type="file" name="subtitle" accept=".vtt" class="block w-full text-sm text-gray-700 file:mr-4 file:py-2 file:px-4
             file:rounded-lg file:border-0
             file:text-sm file:font-semibold
             file:bg-gray-200 file:text-gray-800
             hover:file:bg-gray-300
             focus:outline-none focus:ring-2 focus:ring-gray-400">
      </div>
    </div>

    <!-- Previews -->
    {% if video.thumbnail or video.file %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div>
        {% if video.file %}
        <button type="button" onclick="openModal('videoModal')" title="Video anzeigen"
          class="mb-2 text-blue-600 hover:text-blue-800 flex items-center gap-1">
          <i class="bi bi-play-circle-fill"></i> Vorschau Video
        </button>
        {% endif %}
      </div>
      <div>
        {% if video.thumbnail %}
        <button type="button" onclick="openModal('thumbnailModal')" title="Thumbnail anzeigen"
          class="mb-2 text-green-600 hover:text-green-800 flex items-center gap-1">
          <i class="bi bi-image-fill"></i> Vorschau Thumbnail
        </button>
        {% endif %}
      </div>
    </div>
    {% endif %}

    <!-- Text Inputs -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="relative">
        <input type="text" name="title" id="title" value="{{ video.title }}"
          class="peer h-12 w-full border-b-2 border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:border-blue-500"
          placeholder="Titel" required>
        <label for="title" class="absolute left-0 -top-3.5 text-gray-600 text-sm transition-all
               peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400
               peer-placeholder-shown:top-2 peer-focus:-top-3.5 peer-focus:text-sm peer-focus:text-gray-600">
          Titel <span class="text-red-500">*</span>
        </label>
      </div>

      <div class="relative">
        <input type="text" name="alt_text" id="alt_text" value="{{ video.alt_text }}"
          class="peer h-12 w-full border-b-2 border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:border-blue-500"
          placeholder="Alt-Text">
        <label for="alt_text" class="absolute left-0 -top-3.5 text-gray-600 text-sm transition-all
               peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400
               peer-placeholder-shown:top-2 peer-focus:-top-3.5 peer-focus:text-sm peer-focus:text-gray-600">
          Alt-Text
        </label>
      </div>

      <div class="relative">
        <input type="text" name="tags" id="tags" value="{{ video.tags }}"
          class="peer h-12 w-full border-b-2 border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:border-blue-500"
          placeholder="Tags">
        <label for="tags" class="absolute left-0 -top-3.5 text-gray-600 text-sm transition-all
               peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400
               peer-placeholder-shown:top-2 peer-focus:-top-3.5 peer-focus:text-sm peer-focus:text-gray-600">
          Tags (kommagetrennt)
        </label>
      </div>

      <div class="relative">
        <input type="text" name="duration" id="duration" value="{{ video.duration }}"
          class="peer h-12 w-full border-b-2 border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:border-blue-500"
          placeholder="Dauer">
        <label for="duration" class="absolute left-0 -top-3.5 text-gray-600 text-sm transition-all
               peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400
               peer-placeholder-shown:top-2 peer-focus:-top-3.5 peer-focus:text-sm peer-focus:text-gray-600">
          Dauer (hh:mm:ss)
        </label>
      </div>

      <!-- Beschreibung -->
      <div class="md:col-span-2 relative">
        <textarea name="description" id="description" rows="4"
          class="peer w-full border-b-2 border-gray-300 text-gray-900 placeholder-transparent focus:outline-none focus:border-blue-500 pt-3"
          placeholder="Beschreibung">{{ video.description }}</textarea>
        <label for="description" class="absolute left-0 -top-3.5 text-gray-600 text-sm transition-all
           peer-placeholder-shown:text-base peer-placeholder-shown:text-gray-400
           peer-placeholder-shown:top-2 peer-focus:-top-3.5 peer-focus:text-sm peer-focus:text-gray-600">
          Beschreibung
        </label>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
      <label for="is_public" class="flex items-center cursor-pointer">
        <div class="relative">
          <input type="checkbox" id="is_public" name="is_public" {% if video.is_public %}checked{% endif %}
            class="sr-only peer">
          <div class="w-11 h-6 bg-gray-300 rounded-full peer peer-checked:bg-blue-600 transition-colors"></div>
          <div
            class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow-md transform peer-checked:translate-x-5 transition-transform">
          </div>
        </div>
        <span class="ml-3 text-sm text-gray-700">Öffentlich sichtbar</span>
      </label>
      {% for name, label in video_options %}
      <label for="{{ name }}" class="flex items-center cursor-pointer">
        <div class="relative">
          <input type="checkbox" id="{{ name }}" name="{{ name }}" {% if option_states|get_item:name %}checked{% endif %}
            class="sr-only peer">
          <div class="w-11 h-6 bg-gray-300 rounded-full peer peer-checked:bg-blue-600 transition-colors"></div>
          <div
            class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow-md transform peer-checked:translate-x-5 transition-transform">
          </div>
        </div>
        <span class="ml-3 text-sm text-gray-700">{{ label }}</span>
      </label>
      {% endfor %}
    </div>
    <div class="mt-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">Preload</label>
      <select name="preload" class="border border-gray-300 rounded px-3 py-2 w-96">
        <option value="auto" {% if video.preload == 'auto' %}selected{% endif %}>Auto</option>
        <option value="metadata" {% if video.preload == 'metadata' %}selected{% endif %}>Metadata</option>
        <option value="none" {% if video.preload == 'none' %}selected{% endif %}>None</option>
      </select>
    </div>
  </form>
</div>

<!-- Modal für Thumbnail -->
<div id="thumbnailModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-60 flex items-center justify-center">
  <div class="relative bg-white p-4 rounded shadow-xl max-w-6xl w-full">
    <button onclick="closeModal('thumbnailModal')" class="absolute top-2 right-2 text-gray-600 hover:text-red-600">
      <i class="bi bi-x-lg text-xl"></i>
    </button>
    <img src="{{ video.thumbnail.url }}" alt="Thumbnail Vorschau" class="rounded max-w-full h-auto mt-8">
  </div>
</div>

<!-- Modal für Video -->
<div id="videoModal" class="fixed inset-0 z-50 hidden bg-black bg-opacity-60 flex items-center justify-center">
  <div class="relative bg-white p-4 rounded shadow-xl max-w-3xl w-full">
    <button onclick="closeModal('videoModal')" class="absolute top-2 right-2 text-gray-600 hover:text-red-600">
      <i class="bi bi-x-lg text-xl"></i>
    </button>
    <video controls class="w-full mt-8 rounded" preload="metadata">
      <source src="{{ video.file.url }}" type="video/mp4">
      Dein Browser unterstützt das Video-Tag nicht.
    </video>
  </div>
</div>

{% endblock %}

{% block javascriptend %}
<script>
  // Dauerfeld automatisch formatieren (hh:mm:ss)
  const durationInput = document.getElementById('duration');

  durationInput.addEventListener('input', function (e) {
    let value = e.target.value.replace(/\D/g, ''); // Nur Ziffern
    if (value.length > 6) value = value.slice(0, 6);

    let formatted = '';
    if (value.length > 0) formatted += value.substring(0, 2);
    if (value.length > 2) formatted += ':' + value.substring(2, 4);
    if (value.length > 4) formatted += ':' + value.substring(4, 6);
    e.target.value = formatted;
  });

  // Submit mit Validierung
  $('#video-edit-form').submit(function (e) {
    e.preventDefault();
    const title = $('#title').val().trim();
    const duration = $('#duration').val();
    const pattern = /^([0-1]?\d|2[0-3]):([0-5]?\d):([0-5]?\d)$/;

    if (!title) {
      sendNotif('Bitte gib einen Titel ein.', 'error');
      return;
    }

    if (duration && !pattern.test(duration)) {
      sendNotif('Bitte gib die Dauer im Format hh:mm:ss ein (z.B. 00:03:45).', "error");
      return;
    }

    const formData = new FormData(this);
    const isPublic = $('#is_public').prop('checked');
    formData.set('is_public', isPublic);
    const booleanFields = ['autoplay', 'muted', 'loop', 'playsinline', 'show_controls'];
    booleanFields.forEach(field => {
      formData.set(field, $('#' + field).prop('checked'));
    });

    $.ajax({
      url: "{% url 'cms:edit_video' video.pk %}",
      type: "POST",
      data: formData,
      processData: false,
      contentType: false,
      success: function (response) {
        if (response.success) {
          //window.location.href = response.redirect;
          sendNotif("Änderungen wurden gespeichert.", "success");
        } else {
          sendNotif("Beim Aktualisieren ist ein Fehler aufgetreten.", "error");
        }
      },
      error: function (xhr) {
        const response = xhr.responseJSON;
        if (response && response.error) {
          sendNotif(response.error, "error");
        } else {
          sendNotif("Ein unbekannter Fehler ist aufgetreten.", "error");
        }
      }
    });
  });
  // Titel live aktualisieren in der Breadcrumb
  $('#title').on('input', function () {
    const value = $(this).val().trim();
    $('#videoTitle').text(value || 'Video Titel');
  });

  // Klick auf oberen "Änderungen speichern"-Button triggert das Form-Submit
  $('#editVideo').on('click', function () {
    $('#video-edit-form').submit();
  });

  function openModal(id) {
    $('#' + id).removeClass('hidden');
  }

  function closeModal(id) {
    $('#' + id).addClass('hidden');
  }

  // Modal per Klick außerhalb schließen
  document.addEventListener('click', function (event) {
    ['thumbnailModal', 'videoModal'].forEach(function (id) {
      const modal = document.getElementById(id);
      if (!modal.classList.contains('hidden') && event.target === modal) {
        closeModal(id);
      }
    });
  });


</script>
{% endblock %}